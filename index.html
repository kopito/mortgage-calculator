<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Compare mortgage repayment paths with and without an offset account" />
  <meta name="theme-color" content="#22d3ee" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Mortgage Calc" />
  <title>Mortgage Amortization Calculator</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #22d3ee;
      --accent-2: #a855f7;
      --danger: #f87171;
      --success: #4ade80;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0b1224 0%, #0f172a 50%, #0d1323 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 32px;
    }
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    body.embed {
      padding: 16px;
      background: transparent;
    }
    body.embed .app-container {
      max-width: 100%;
    }
    h1 { margin: 0 0 4px; font-size: 28px; font-weight: 700; color: #f8fafc; }
    p.lead { margin: 0 0 24px; color: var(--muted); }
    .layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      align-items: start;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.25);
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
      font-weight: 600;
    }
    label {
      display: block;
      font-weight: 600;
      color: #cbd5e1;
      margin-bottom: 6px;
    }
    input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #0f172a;
      color: #f8fafc;
      font-size: 14px;
      transition: border 0.15s ease, box-shadow 0.15s ease;
    }
    select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #0f172a;
      color: #f8fafc;
      font-size: 14px;
      transition: border 0.15s ease, box-shadow 0.15s ease;
    }
    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.25);
    }
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.25);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }
    .actions {
      margin-top: 16px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.2s ease;
    }
    button.primary {
      background: linear-gradient(135deg, #22d3ee, #6366f1);
      color: #0b1224;
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.35);
    }
    button.secondary {
      background: #0f172a;
      color: var(--text);
      border: 1px solid #1f2937;
    }
    button.danger {
      background: #ef4444;
      color: #0b1224;
      border: 1px solid rgba(248, 113, 113, 0.6);
      box-shadow: 0 10px 25px rgba(239, 68, 68, 0.25);
    }
    button:hover { transform: translateY(-1px) scale(1.01); }
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }
    .stat {
      background: #111827;
      border: 1px solid #1f2937;
      padding: 14px;
      border-radius: 12px;
    }
    .stat label { color: var(--muted); font-weight: 500; margin-bottom: 4px; }
    .stat .value { font-size: 18px; font-weight: 700; }
    .chip {
      display: inline-flex;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(34, 211, 238, 0.15);
      color: #a5f3fc;
      border: 1px solid rgba(34, 211, 238, 0.35);
      font-weight: 600;
      font-size: 12px;
      align-items: center;
      gap: 6px;
    }
    .toggle {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      background: #0f172a;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      border-radius: 12px;
    }
    .chart-card {
      height: 440px;
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      color: #e2e8f0;
      font-size: 14px;
    }
    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid #1f2937;
      text-align: left;
    }
    th { color: #cbd5e1; font-weight: 600; }
    .muted { color: var(--muted); }
    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 12px;
    }
    .pill.green { background: rgba(74, 222, 128, 0.15); color: #4ade80; border: 1px solid rgba(74, 222, 128, 0.35); }
    .pill.red { background: rgba(248, 113, 113, 0.15); color: #fca5a5; border: 1px solid rgba(248, 113, 113, 0.35); }
    @media (max-width: 980px) {
      body { padding: 18px; }
      .layout { grid-template-columns: 1fr; }
      .stat-grid { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
      h1 { font-size: 24px; }
      .chart-card { height: 360px; }
    }
    @media (max-width: 480px) {
      body { padding: 12px; }
      .card { padding: 16px; }
      .chart-card { height: 300px; }
    }
  </style>
</head>
<body>
  <div class="app-container">
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
      <div>
        <h1>Mortgage Amortization Dashboard</h1>
        <p class="lead">Compare repayment paths with and without an offset account.</p>
      </div>
      <div class="chip">Powered by Chart.js</div>
    </div>
  </header>

  <div class="layout">
    <section class="card">
      <h2>Select Country</h2>
      <div id="countryButtons" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
      <p class="muted" style="margin:10px 0 0;">Country selection prepares region-specific settings.</p>
    </section>

    <section class="card" id="loanInputsCard">
      <h2>Loan Inputs</h2>
      <div class="grid">
        <div>
          <label for="principal" id="labelPrincipal">Loan Amount</label>
          <input id="principal" type="number" min="1" step="1000" value="600000" />
        </div>
        <div>
          <label for="rate">Annual Interest Rate (%)</label>
          <input id="rate" type="number" min="0" step="0.01" value="6.5" />
        </div>
        <div>
          <label for="frequency">Repayment Frequency</label>
          <select id="frequency">
            <option value="monthly" selected>Monthly</option>
            <option value="biweekly">Biweekly</option>
            <option value="weekly">Weekly</option>
          </select>
        </div>
        <div>
          <label for="years">Term (Years)</label>
          <input id="years" type="number" min="1" step="1" value="30" />
        </div>
        <div id="offsetSection">
          <label for="offset" id="labelOffset">Offset Balance</label>
          <input id="offset" type="number" min="0" step="500" value="80000" />
        </div>
        <div id="offsetOptionsSection">
          <div>
            <label for="offsetMode">Offset Mode</label>
            <select id="offsetMode">
              <option value="constant" selected>Constant from start month</option>
              <option value="contribution">Monthly contributions (range)</option>
            </select>
          </div>
          <div>
            <label for="offsetStartMonth">Offset Start Month</label>
            <input id="offsetStartMonth" type="number" min="1" step="1" value="1" />
          </div>
          <div>
            <label for="offsetEndMonth">Offset End Month</label>
            <input id="offsetEndMonth" type="number" min="1" step="1" value="120" />
          </div>
          <div>
            <label for="offsetMonthlyAdd">Monthly Offset Add ($)</label>
            <input id="offsetMonthlyAdd" type="number" min="0" step="100" value="500" />
          </div>
        </div>
      </div>
      <div class="actions">
        <button id="calc" class="primary">Calculate</button>
        <button id="reset" class="secondary">Reset</button>
        <button id="download" class="secondary danger">Download Excel (CSV)</button>
        <label class="toggle" id="compareToggleWrapper">
          <input id="showBoth" type="checkbox" checked />
          <span>Compare with & without offset</span>
        </label>
      </div>
    </section>

    <section class="card" id="israelTracksCard" style="display:none;">
      <h2>Israel Mortgage Tracks</h2>
      <div class="grid" style="margin-bottom:8px;">
        <div>
          <label for="trackCount">Number of Tracks</label>
          <input id="trackCount" type="number" min="1" max="4" step="1" value="2" />
        </div>
        <div>
          <label class="muted">Note</label>
          <div class="muted">Monthly payments only. Offset not available.</div>
        </div>
      </div>
      <div id="trackList" style="display:grid; gap:10px;"></div>
      <div id="trackWarning" class="muted" style="margin-top:8px;"></div>
      <table style="margin-top:12px;">
        <thead>
          <tr>
            <th>Track</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Interest</th>
            <th>Monthly Payment</th>
          </tr>
        </thead>
        <tbody id="trackPaymentRows"></tbody>
      </table>
    </section>

  </div>

  <section class="card chart-card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <div>
        <h2>Balance Over Time</h2>
        <p class="muted" style="margin:0;">Monthly remaining balance projection</p>
      </div>
      <div id="offsetLegend" style="display:flex; gap:8px;">
        <span class="pill green">With Offset</span>
        <span class="pill red">Without Offset</span>
      </div>
    </div>
    <canvas id="chart" height="320"></canvas>
  </section>

  <section class="card" style="margin-top:16px;">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
      <h2>Summary</h2>
      <div class="chip" id="timeSavedChip">Time saved: 0 months</div>
    </div>
    <div class="stat-grid" style="margin-top:10px;">
      <div class="stat">
        <label>Total Interest (With Offset)</label>
        <div class="value" id="interestWith">$0</div>
        <div class="muted" id="interestWithPct">—</div>
      </div>
      <div class="stat">
        <label>Total Interest (Without Offset)</label>
        <div class="value" id="interestWithout">$0</div>
        <div class="muted">Baseline interest</div>
      </div>
      <div class="stat">
        <label>Principal Paid</label>
        <div class="value" id="principalPaid">$0</div>
        <div class="muted">Total principal over term</div>
      </div>
      <div class="stat">
        <label>Payment Amount</label>
        <div class="value" id="paymentAmount">$0</div>
        <div class="muted" id="paymentFrequencyLabel">Per payment</div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Scenario</th>
          <th>Months</th>
          <th>Total Interest</th>
          <th>Total Principal</th>
          <th>Time Saved</th>
        </tr>
      </thead>
      <tbody id="summaryRows"></tbody>
    </table>
  </section>

  <section class="card" style="margin-top:16px;">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:8px;">
      <div>
        <h2>Cumulative Payments</h2>
        <p class="muted" style="margin:0;">Total paid over time: interest vs principal</p>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <span class="pill green" id="cumulativePrincipalLabel">Principal (with offset)</span>
        <span class="pill red" id="cumulativeInterestLabel">Interest (with offset)</span>
        <span class="pill" id="cumulativeTotalLabel" style="background:rgba(56,189,248,0.15);border:1px solid rgba(56,189,248,0.4);color:#7dd3fc;">Total paid</span>
      </div>
    </div>
    <div style="height:360px;">
      <canvas id="cumulativeChart" height="280"></canvas>
    </div>
  </section>

  <script>
    let activeCountry = 'AU';
    let israelTracks = [];
    const israelTrackTypes = [
      { id: 'fixed', label: 'Fixed' },
      { id: 'variable', label: 'Variable' },
      { id: 'cpi', label: 'CPI-linked' }
    ];
    const countries = {
      AU: { name: 'Australia', currency: 'AUD', locale: 'en-AU', defaults: { principal: 600000, rate: 6.5, years: 30, offset: 80000 } },
      IL: { name: 'Israel', currency: 'ILS', locale: 'he-IL', defaults: { principal: 1500000, rate: 5.2, years: 25, offset: 100000 } },
      US: { name: 'USA', currency: 'USD', locale: 'en-US', defaults: { principal: 450000, rate: 6.2, years: 30, offset: 50000 } },
      UK: { name: 'UK', currency: 'GBP', locale: 'en-GB', defaults: { principal: 350000, rate: 5.0, years: 25, offset: 40000 } },
      FR: { name: 'France', currency: 'EUR', locale: 'fr-FR', defaults: { principal: 300000, rate: 4.0, years: 25, offset: 30000 } },
      DE: { name: 'Germany', currency: 'EUR', locale: 'de-DE', defaults: { principal: 350000, rate: 4.2, years: 25, offset: 35000 } }
    };

    const fmtCurrency = (v) => {
      const { locale, currency } = countries[activeCountry] || countries.AU;
      return v.toLocaleString(locale, { style: 'currency', currency, maximumFractionDigits: 0 });
    };

    const fmtMonths = (m) => `${Math.floor(m / 12)}y ${m % 12}m`;

    const frequencyConfig = {
      monthly: { periodsPerYear: 12, label: 'Monthly' },
      biweekly: { periodsPerYear: 26, label: 'Biweekly' },
      weekly: { periodsPerYear: 52, label: 'Weekly' }
    };

    function periodicPayment(principal, annualRate, years, periodsPerYear) {
      const n = years * periodsPerYear;
      const r = annualRate / periodsPerYear / 100;
      if (r === 0) return principal / n;
      return principal * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
    }

    function buildSchedule(principal, annualRate, years, offsetConfig, periodsPerYear) {
      const payment = periodicPayment(principal, annualRate, years, periodsPerYear);
      const r = annualRate / periodsPerYear / 100;
      let balance = principal;
      let month = 0;
      let offsetBalance = offsetConfig?.baseOffset ?? 0;
      const balances = [balance];
      let totalInterest = 0;
      let totalPrincipal = 0;
      const cumulativeInterest = [0];
      const cumulativePrincipal = [0];
      const cumulativeTotal = [0];
      const interestPayments = [0];
      const principalPayments = [0];
      const totalPayments = [0];
      const offsetSeries = [0];
      const maxMonths = years * periodsPerYear + 120; // guardrail

      while (balance > 0 && month < maxMonths) {
        month += 1;

        let currentOffset = 0;
        if (!offsetConfig || offsetConfig.mode === 'none') {
          currentOffset = 0;
        } else if (offsetConfig.mode === 'constant') {
          currentOffset = month >= offsetConfig.startMonth ? offsetConfig.baseOffset : 0;
        } else if (offsetConfig.mode === 'contribution') {
          if (month >= offsetConfig.startMonth && month <= offsetConfig.endMonth) {
            offsetBalance += offsetConfig.monthlyAdd;
          }
          currentOffset = offsetBalance;
        }

        const effectiveBalance = Math.max(0, balance - currentOffset);
        const interest = effectiveBalance * r;
        let principalPaid = payment - interest;
        // Ensure we do not overpay on the final installment
        if (principalPaid > balance) {
          principalPaid = balance;
        }
        balance = Math.max(0, balance - principalPaid);
        totalInterest += interest;
        totalPrincipal += principalPaid;
        balances.push(balance);
        cumulativeInterest.push(totalInterest);
        cumulativePrincipal.push(totalPrincipal);
        cumulativeTotal.push(totalInterest + totalPrincipal);
        interestPayments.push(interest);
        principalPayments.push(principalPaid);
        totalPayments.push(interest + principalPaid);
        offsetSeries.push(currentOffset);
        if (balance === 0) break;
      }
      return {
        balances,
        payment,
        totalInterest,
        totalPrincipal,
        months: month,
        cumulativeInterest,
        cumulativePrincipal,
        cumulativeTotal,
        interestPayments,
        principalPayments,
        totalPayments,
        offsetSeries
      };
    }

    const chartCtx = document.getElementById('chart').getContext('2d');
    const cumulativeCtx = document.getElementById('cumulativeChart').getContext('2d');
    let chart;
    let cumulativeChart;

    function render(principal, rate, years, offsetConfig, showBoth, frequencyKey) {
      const freq = frequencyConfig[frequencyKey] || frequencyConfig.monthly;
      const withOffset = buildSchedule(principal, rate, years, offsetConfig, freq.periodsPerYear);
      const withoutOffset = buildSchedule(principal, rate, years, { mode: 'none' }, freq.periodsPerYear);

      const maxMonths = Math.max(withOffset.balances.length, withoutOffset.balances.length);
      const labels = Array.from({ length: maxMonths }, (_, i) => i);

      if (chart) chart.destroy();
      chart = new Chart(chartCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'With Offset',
              data: withOffset.balances,
              tension: 0.15,
              borderColor: '#4ade80',
              backgroundColor: 'rgba(74, 222, 128, 0.15)',
              borderWidth: 3,
              fill: true,
              hidden: false
            },
            {
              label: 'Without Offset',
              data: withoutOffset.balances,
              tension: 0.15,
              borderColor: '#f87171',
              backgroundColor: 'rgba(248, 113, 113, 0.12)',
              borderWidth: 2,
              borderDash: [6, 4],
              fill: true,
              hidden: !showBoth
            },
            {
              label: 'Offset Balance',
              data: withOffset.offsetSeries,
              tension: 0.15,
              borderColor: '#38bdf8',
              backgroundColor: 'rgba(56, 189, 248, 0.1)',
              borderWidth: 2,
              fill: false,
              hidden: activeCountry === 'IL'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: { bottom: 16 }
          },
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#e5e7eb', usePointStyle: true } },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${fmtCurrency(ctx.parsed.y)}`
              }
            }
          },
          scales: {
            x: { ticks: { color: '#9ca3af' }, title: { display: true, text: 'Payment Period', color: '#9ca3af' }, grid: { color: '#1f2937' } },
            y: { ticks: { color: '#9ca3af' }, title: { display: true, text: 'Balance ($)', color: '#9ca3af' }, grid: { color: '#1f2937' } }
          }
        }
      });

      if (cumulativeChart) cumulativeChart.destroy();
      cumulativeChart = new Chart(cumulativeCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Cumulative Principal (with offset)',
              data: withOffset.cumulativePrincipal,
              tension: 0.15,
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34,197,94,0.18)',
              borderWidth: 2,
              fill: true
            },
            {
              label: 'Cumulative Interest (with offset)',
              data: withOffset.cumulativeInterest,
              tension: 0.15,
              borderColor: '#f97316',
              backgroundColor: 'rgba(249,115,22,0.18)',
              borderWidth: 2,
              fill: true
            },
            {
              label: 'Cumulative Total Paid (with offset)',
              data: withOffset.cumulativeTotal,
              tension: 0.15,
              borderColor: '#38bdf8',
              backgroundColor: 'rgba(56,189,248,0.15)',
              borderWidth: 2,
              fill: false
            },
            {
              label: 'Cumulative Total Paid (without offset)',
              data: withoutOffset.cumulativeTotal,
              tension: 0.15,
              borderColor: '#f97373',
              backgroundColor: 'rgba(248,113,113,0.08)',
              borderWidth: 2,
              borderDash: [6, 4],
              fill: false,
              hidden: !showBoth
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#e5e7eb', usePointStyle: true } },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${fmtCurrency(ctx.parsed.y)}`
              }
            }
          },
          scales: {
            x: { ticks: { color: '#9ca3af' }, title: { display: true, text: 'Payment Period', color: '#9ca3af' }, grid: { color: '#1f2937' } },
            y: { ticks: { color: '#9ca3af' }, title: { display: true, text: 'Cumulative Paid ($)', color: '#9ca3af' }, grid: { color: '#1f2937' } }
          }
        }
      });

      updateSummary(withOffset, withoutOffset, offsetConfig?.baseOffset ?? 0, withOffset.payment, freq.label);
    }

    function applyCountry(countryCode) {
      activeCountry = countryCode;
      const config = countries[countryCode] || countries.AU;
      const currencyLabel = ` (${config.currency})`;
      document.getElementById('labelPrincipal').textContent = `Loan Amount${currencyLabel}`;
      document.getElementById('labelOffset').textContent = `Offset Balance${currencyLabel}`;
      document.getElementById('principal').value = config.defaults.principal;
      document.getElementById('rate').value = config.defaults.rate;
      document.getElementById('years').value = config.defaults.years;
      document.getElementById('offset').value = config.defaults.offset;
      document.getElementById('frequency').value = 'monthly';
      document.getElementById('frequency').disabled = countryCode === 'IL';
      document.getElementById('loanInputsCard').style.display = countryCode === 'IL' ? 'none' : 'block';
      document.getElementById('offsetSection').style.display = countryCode === 'IL' ? 'none' : 'block';
      document.getElementById('offsetOptionsSection').style.display = countryCode === 'IL' ? 'none' : 'contents';
      document.getElementById('offsetMode').disabled = countryCode === 'IL';
      document.getElementById('offsetStartMonth').disabled = countryCode === 'IL';
      document.getElementById('offsetEndMonth').disabled = countryCode === 'IL';
      document.getElementById('offsetMonthlyAdd').disabled = countryCode === 'IL';
      document.getElementById('compareToggleWrapper').style.display = countryCode === 'IL' ? 'none' : 'inline-flex';
      document.getElementById('offsetLegend').style.display = countryCode === 'IL' ? 'none' : 'flex';
      document.getElementById('israelTracksCard').style.display = countryCode === 'IL' ? 'block' : 'none';
      document.getElementById('cumulativePrincipalLabel').textContent = countryCode === 'IL'
        ? 'Total Principal Paid'
        : 'Principal (with offset)';
      document.getElementById('cumulativeInterestLabel').textContent = countryCode === 'IL'
        ? 'Total Interest Paid'
        : 'Interest (with offset)';
      document.getElementById('cumulativeTotalLabel').textContent = countryCode === 'IL'
        ? 'Total Paid'
        : 'Total paid';
      if (countryCode === 'IL') {
        initIsraelTracks(config.defaults.principal, config.defaults.rate, Number(document.getElementById('trackCount').value) || 2);
        renderTrackInputs();
      }
      calculate();
    }

    function renderCountryButtons() {
      const container = document.getElementById('countryButtons');
      container.innerHTML = '';
      Object.entries(countries).forEach(([code, data]) => {
        const btn = document.createElement('button');
        btn.className = code === activeCountry ? 'primary' : 'secondary';
        btn.textContent = data.name;
        btn.addEventListener('click', () => {
          activeCountry = code;
          renderCountryButtons();
          applyCountry(code);
        });
        container.appendChild(btn);
      });
    }

    function initIsraelTracks(principal, rate, count) {
      const safeCount = Math.min(Math.max(count, 1), 4);
      const perTrack = Math.floor(principal / safeCount);
      israelTracks = Array.from({ length: safeCount }, (_, idx) => ({
        name: `Track ${idx + 1}`,
        amount: idx === safeCount - 1 ? principal - perTrack * (safeCount - 1) : perTrack,
        rate,
        type: 'fixed'
      }));
    }

    function renderTrackInputs() {
      const container = document.getElementById('trackList');
      const count = Math.min(Math.max(Number(document.getElementById('trackCount').value) || 1, 1), 4);
      if (israelTracks.length !== count) {
        const principal = Number(document.getElementById('principal').value) || 0;
        const rate = Number(document.getElementById('rate').value) || 0;
        initIsraelTracks(principal, rate, count);
      }
      container.innerHTML = '';
      israelTracks.forEach((track, idx) => {
        const row = document.createElement('div');
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr 1fr 1fr 1fr';
        row.style.gap = '10px';
        row.innerHTML = `
          <div>
            <label>Track Name</label>
            <input data-track-name="${idx}" type="text" value="${track.name}" />
          </div>
          <div>
            <label>Track Type</label>
            <select data-track-type="${idx}">
              ${israelTrackTypes.map((type) => `
                <option value="${type.id}" ${type.id === track.type ? 'selected' : ''}>${type.label}</option>
              `).join('')}
            </select>
          </div>
          <div>
            <label>Track Amount</label>
            <input data-track-amount="${idx}" type="number" min="0" step="1000" value="${track.amount}" />
          </div>
          <div>
            <label>Track Interest (%)</label>
            <input data-track-rate="${idx}" type="number" min="0" step="0.01" value="${track.rate}" />
          </div>
        `;
        container.appendChild(row);
      });
    }

    function readIsraelTracks() {
      const tracks = israelTracks.map((track, idx) => {
        const name = document.querySelector(`[data-track-name="${idx}"]`)?.value || track.name;
        const type = document.querySelector(`[data-track-type="${idx}"]`)?.value || track.type || 'fixed';
        const amount = Number(document.querySelector(`[data-track-amount="${idx}"]`)?.value) || 0;
        const rate = Number(document.querySelector(`[data-track-rate="${idx}"]`)?.value) || 0;
        return { name, type, amount, rate };
      });
      israelTracks = tracks;
      return tracks;
    }

    function combineSeries(schedules, getter) {
      const maxLen = Math.max(...schedules.map((s) => getter(s).length));
      return Array.from({ length: maxLen }, (_, i) =>
        schedules.reduce((sum, s) => sum + (getter(s)[i] ?? 0), 0)
      );
    }

    function toCsvValue(value) {
      if (value === null || value === undefined) return '';
      const str = String(value);
      return str.includes(',') ? `"${str.replace(/"/g, '""')}"` : str;
    }

    function downloadCsv(filename, rows) {
      const content = rows.map((row) => row.map(toCsvValue).join(',')).join('\n');
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
    }

    function exportAustralia(values) {
      const showBoth = document.getElementById('showBoth').checked;
      const offsetConfig = {
        mode: values.offsetMode,
        baseOffset: values.offset,
        startMonth: values.offsetStartMonth,
        endMonth: values.offsetEndMonth,
        monthlyAdd: values.offsetMonthlyAdd
      };
      const freq = frequencyConfig[values.frequency] || frequencyConfig.monthly;
      const withOffset = buildSchedule(values.principal, values.rate, values.years, offsetConfig, freq.periodsPerYear);
      const withoutOffset = buildSchedule(values.principal, values.rate, values.years, { mode: 'none' }, freq.periodsPerYear);
      const maxLen = Math.max(withOffset.balances.length, withoutOffset.balances.length);

      const rows = [];
      const header = [
        'Period',
        'With Offset Payment',
        'With Offset Interest',
        'With Offset Principal',
        'With Offset Balance'
      ];
      if (showBoth) {
        header.push(
          'Without Offset Payment',
          'Without Offset Interest',
          'Without Offset Principal',
          'Without Offset Balance'
        );
      }
      rows.push(header);

      for (let i = 0; i < maxLen; i += 1) {
        const row = [
          i,
          withOffset.totalPayments[i] ?? 0,
          withOffset.interestPayments[i] ?? 0,
          withOffset.principalPayments[i] ?? 0,
          withOffset.balances[i] ?? 0
        ];
        if (showBoth) {
          row.push(
            withoutOffset.totalPayments[i] ?? 0,
            withoutOffset.interestPayments[i] ?? 0,
            withoutOffset.principalPayments[i] ?? 0,
            withoutOffset.balances[i] ?? 0
          );
        }
        rows.push(row);
      }
      downloadCsv(`mortgage_${activeCountry.toLowerCase()}_${values.frequency}.csv`, rows);
    }

    function exportIsrael(values) {
      const tracks = readIsraelTracks();
      const schedules = tracks.map((track) =>
        buildSchedule(track.amount, track.rate, values.years, { mode: 'none' }, 12)
      );
      const maxLen = Math.max(...schedules.map((s) => s.balances.length));
      const rows = [];

      const header = [
        'Period',
        'Total Payment',
        'Total Interest',
        'Total Principal',
        'Total Balance'
      ];
      tracks.forEach((track) => {
        header.push(
          `${track.name} Type`,
          `${track.name} Payment`,
          `${track.name} Interest`,
          `${track.name} Principal`,
          `${track.name} Balance`
        );
      });
      rows.push(header);

      for (let i = 0; i < maxLen; i += 1) {
        const totalPayment = schedules.reduce((sum, s) => sum + (s.totalPayments[i] ?? 0), 0);
        const totalInterest = schedules.reduce((sum, s) => sum + (s.interestPayments[i] ?? 0), 0);
        const totalPrincipal = schedules.reduce((sum, s) => sum + (s.principalPayments[i] ?? 0), 0);
        const totalBalance = schedules.reduce((sum, s) => sum + (s.balances[i] ?? 0), 0);

        const row = [i, totalPayment, totalInterest, totalPrincipal, totalBalance];
        schedules.forEach((s, idx) => {
          row.push(
            tracks[idx]?.type || '',
            s.totalPayments[i] ?? 0,
            s.interestPayments[i] ?? 0,
            s.principalPayments[i] ?? 0,
            s.balances[i] ?? 0
          );
        });
        rows.push(row);
      }
      downloadCsv(`mortgage_israel_monthly.csv`, rows);
    }

    function renderIsrael(values) {
      const tracks = readIsraelTracks();
      const schedules = tracks.map((track) =>
        buildSchedule(track.amount, track.rate, values.years, { mode: 'none' }, 12)
      );

      const totalInterest = schedules.reduce((sum, s) => sum + s.totalInterest, 0);
      const totalPrincipal = schedules.reduce((sum, s) => sum + s.totalPrincipal, 0);
      const totalMonths = Math.max(...schedules.map((s) => s.months));
      const totalPayment = schedules.reduce((sum, s) => sum + s.payment, 0);

      const combinedBalances = combineSeries(schedules, (s) => s.balances);
      const combinedCumulativeInterest = combineSeries(schedules, (s) => s.cumulativeInterest);
      const combinedCumulativePrincipal = combineSeries(schedules, (s) => s.cumulativePrincipal);
      const combinedCumulativeTotal = combineSeries(schedules, (s) => s.cumulativeTotal);

      const warning = document.getElementById('trackWarning');
      const sumAmounts = tracks.reduce((sum, t) => sum + t.amount, 0);
      warning.textContent = sumAmounts !== values.principal
        ? `Track amounts sum to ${fmtCurrency(sumAmounts)} (loan is ${fmtCurrency(values.principal)}).`
        : '';

      const paymentRows = document.getElementById('trackPaymentRows');
      paymentRows.innerHTML = '';
      tracks.forEach((track, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${track.name}</td>
          <td>${israelTrackTypes.find((t) => t.id === track.type)?.label || track.type}</td>
          <td>${fmtCurrency(track.amount)}</td>
          <td>${track.rate.toFixed(2)}%</td>
          <td>${fmtCurrency(schedules[idx].payment)}</td>
        `;
        paymentRows.appendChild(tr);
      });

      if (chart) chart.destroy();
      chart = new Chart(chartCtx, {
        type: 'line',
        data: {
          labels: Array.from({ length: combinedBalances.length }, (_, i) => i),
          datasets: [
            {
              label: 'Total Balance (Israel)',
              data: combinedBalances,
              tension: 0.15,
              borderColor: '#4ade80',
              backgroundColor: 'rgba(74, 222, 128, 0.15)',
              borderWidth: 3,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#e5e7eb', usePointStyle: true } },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${fmtCurrency(ctx.parsed.y)}`
              }
            }
          },
          scales: {
            x: { ticks: { color: '#9ca3af' }, title: { display: true, text: 'Month', color: '#9ca3af' }, grid: { color: '#1f2937' } },
            y: { ticks: { color: '#9ca3af' }, title: { display: true, text: 'Balance ($)', color: '#9ca3af' }, grid: { color: '#1f2937' } }
          }
        }
      });

      if (cumulativeChart) cumulativeChart.destroy();
      cumulativeChart = new Chart(cumulativeCtx, {
        type: 'line',
        data: {
          labels: Array.from({ length: combinedCumulativeTotal.length }, (_, i) => i),
          datasets: [
            {
              label: 'Total Principal Paid',
              data: combinedCumulativePrincipal,
              tension: 0.15,
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34,197,94,0.18)',
              borderWidth: 2,
              fill: true
            },
            {
              label: 'Total Interest Paid',
              data: combinedCumulativeInterest,
              tension: 0.15,
              borderColor: '#f97316',
              backgroundColor: 'rgba(249,115,22,0.18)',
              borderWidth: 2,
              fill: true
            },
            {
              label: 'Total Paid',
              data: combinedCumulativeTotal,
              tension: 0.15,
              borderColor: '#38bdf8',
              backgroundColor: 'rgba(56,189,248,0.15)',
              borderWidth: 2,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#e5e7eb', usePointStyle: true } },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${fmtCurrency(ctx.parsed.y)}`
              }
            }
          },
          scales: {
            x: { ticks: { color: '#9ca3af' }, title: { display: true, text: 'Month', color: '#9ca3af' }, grid: { color: '#1f2937' } },
            y: { ticks: { color: '#9ca3af' }, title: { display: true, text: 'Cumulative Paid ($)', color: '#9ca3af' }, grid: { color: '#1f2937' } }
          }
        }
      });

      updateSummary(
        { totalInterest, totalPrincipal, months: totalMonths },
        { totalInterest, totalPrincipal, months: totalMonths },
        0,
        totalPayment,
        'Monthly'
      );
    }

    function updateSummary(withOffset, withoutOffset, offset, paymentAmount, frequencyLabel) {
      const interestSaved = withoutOffset.totalInterest - withOffset.totalInterest;
      document.getElementById('interestWith').textContent = fmtCurrency(withOffset.totalInterest);
      document.getElementById('interestWithout').textContent = fmtCurrency(withoutOffset.totalInterest);
      document.getElementById('principalPaid').textContent = fmtCurrency(withoutOffset.totalPrincipal);
      document.getElementById('paymentAmount').textContent = fmtCurrency(paymentAmount);
      document.getElementById('paymentFrequencyLabel').textContent = `Per ${frequencyLabel.toLowerCase()} payment`;

      const pct = withoutOffset.totalInterest > 0
        ? (interestSaved / withoutOffset.totalInterest) * 100
        : 0;
      if (activeCountry === 'IL') {
        document.getElementById('interestWithPct').textContent = 'Offset not applicable in Israel';
      } else {
        document.getElementById('interestWithPct').textContent =
          `Saves ${fmtCurrency(interestSaved)} (${pct.toFixed(1)}%) via ${fmtCurrency(offset)} offset`;
      }

      const timeSaved = Math.max(0, withoutOffset.months - withOffset.months);
      document.getElementById('timeSavedChip').textContent = activeCountry === 'IL'
        ? 'Offset not available'
        : `Time saved: ${timeSaved} months`;

      const tbody = document.getElementById('summaryRows');
      tbody.innerHTML = '';
      const rows = activeCountry === 'IL'
        ? [
          {
            label: 'Total (Israel tracks)',
            months: withOffset.months,
            interest: withOffset.totalInterest,
            principal: withOffset.totalPrincipal,
            time: '—'
          }
        ]
        : [
          {
            label: 'With Offset',
            months: withOffset.months,
            interest: withOffset.totalInterest,
            principal: withOffset.totalPrincipal,
            time: `-${timeSaved} mo`
          },
          {
            label: 'Without Offset',
            months: withoutOffset.months,
            interest: withoutOffset.totalInterest,
            principal: withoutOffset.totalPrincipal,
            time: 'Baseline'
          }
        ];
      rows.forEach((row, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="display:flex; align-items:center; gap:8px;">
            <span class="pill ${idx === 0 ? 'green' : 'red'}">${row.label}</span>
          </td>
          <td>${fmtMonths(row.months)}</td>
          <td>${fmtCurrency(row.interest)}</td>
          <td>${fmtCurrency(row.principal)}</td>
          <td>${row.time}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function readInputs() {
      const principal = Number(document.getElementById('principal').value) || 0;
      const rate = Number(document.getElementById('rate').value) || 0;
      const years = Number(document.getElementById('years').value) || 0;
      const offset = Number(document.getElementById('offset').value) || 0;
      const frequency = document.getElementById('frequency').value;
      const offsetMode = document.getElementById('offsetMode').value;
      const offsetStartMonth = Number(document.getElementById('offsetStartMonth').value) || 1;
      const offsetEndMonth = Number(document.getElementById('offsetEndMonth').value) || offsetStartMonth;
      const offsetMonthlyAdd = Number(document.getElementById('offsetMonthlyAdd').value) || 0;
      const trackCount = Number(document.getElementById('trackCount')?.value) || 0;
      return {
        principal,
        rate,
        years,
        offset,
        frequency,
        offsetMode,
        offsetStartMonth,
        offsetEndMonth,
        offsetMonthlyAdd,
        trackCount
      };
    }

    function validateInputs({ principal, rate, years, offsetMode, offsetStartMonth, offsetEndMonth, offsetMonthlyAdd }) {
      if (principal <= 0) return 'Principal must be greater than zero.';
      if (rate < 0) return 'Rate cannot be negative.';
      if (years <= 0) return 'Term must be at least 1 year.';
      if (offsetStartMonth < 1) return 'Offset start month must be at least 1.';
      if (offsetMode === 'contribution') {
        if (offsetMonthlyAdd < 0) return 'Monthly offset add must be zero or more.';
        if (offsetEndMonth < offsetStartMonth) return 'Offset end month must be after start month.';
      }
      return null;
    }

    function calculate() {
      const values = readInputs();
      const error = validateInputs(values);
      if (error) {
        alert(error);
        return;
      }
      if (activeCountry === 'IL') {
        renderIsrael(values);
        return;
      }
      const showBoth = document.getElementById('showBoth').checked;
      const offsetConfig = {
        mode: values.offsetMode,
        baseOffset: values.offset,
        startMonth: values.offsetStartMonth,
        endMonth: values.offsetEndMonth,
        monthlyAdd: values.offsetMonthlyAdd
      };
      render(values.principal, values.rate, values.years, offsetConfig, showBoth, values.frequency);
    }

    document.getElementById('calc').addEventListener('click', calculate);
    document.getElementById('download').addEventListener('click', () => {
      const values = readInputs();
      if (activeCountry === 'IL') {
        exportIsrael(values);
      } else {
        exportAustralia(values);
      }
    });
    document.getElementById('reset').addEventListener('click', () => {
      document.getElementById('principal').value = 600000;
      document.getElementById('rate').value = 6.5;
      document.getElementById('years').value = 30;
      document.getElementById('offset').value = 80000;
      document.getElementById('frequency').value = 'monthly';
      document.getElementById('offsetMode').value = 'constant';
      document.getElementById('offsetStartMonth').value = 1;
      document.getElementById('offsetEndMonth').value = 120;
      document.getElementById('offsetMonthlyAdd').value = 500;
      if (activeCountry === 'IL') {
        initIsraelTracks(1500000, 5.2, 2);
        renderTrackInputs();
      }
      document.getElementById('showBoth').checked = true;
      calculate();
    });
    document.getElementById('showBoth').addEventListener('change', calculate);
    ['principal', 'rate', 'years', 'offset', 'frequency', 'offsetMode', 'offsetStartMonth', 'offsetEndMonth', 'offsetMonthlyAdd', 'trackCount'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        if (id === 'trackCount' && activeCountry === 'IL') {
          renderTrackInputs();
        }
        calculate();
      });
      document.getElementById(id).addEventListener('keyup', (e) => {
        if (e.key === 'Enter') calculate();
      });
    });
    document.getElementById('trackList').addEventListener('input', calculate);

    // Initial render
    renderCountryButtons();
    applyCountry(activeCountry);

    // Enable embed-friendly layout when used inside Wix iframes
    if (window.self !== window.top) {
      document.body.classList.add('embed');
    }

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((reg) => console.log('Service Worker registered'))
          .catch((err) => console.log('Service Worker registration failed:', err));
      });
    }
  </script>
  </div>
</body>
</html>
